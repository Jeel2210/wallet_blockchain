<!DOCTYPE html>
<html>

<head>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Transaction History</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <script src='https://kit.fontawesome.com/a076d05399.js' crossorigin='anonymous'></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js" type="text/javascript"></script>
    <style>
        body {
            font-family: Arial, Helvetica, sans-serif;
        }

        * {
            box-sizing: border-box;
        }

        .container {
            /* height: 740px; */
            height: 850px;
            /* background: linear-gradient(to bottom, #ffcc66 0%, #cc99ff 100%); */
            /* background: linear-gradient(to top, #808080 9%, #ffffff 100%); */
            background: linear-gradient(to top, #bbbaba 9%, #ffffff 100%);


            /* background: linear-gradient(to top, #808080 0%, #ffffff 100%); */
            opacity: 0.8;
            /* padding: 20px 100px; */
            /* width: 70%; */
            max-width: 100%;
            /* margin-left: 70px;
            margin-top: 30px; */
            margin: 30px 70px;
            /* text-align: c; */
        }

        table {
            /* margin-left: 30px;
            margin-right: 30px; */
            margin: 40px 60px;
            /* table { */
            /* border-collapse: separate; */
            border-collapse: collapse;
            /* border-spacing: 0 30px; */
            /* border: 1px solid black; */
            width: 95%;
            /* padding-left: 90px; */

        }

        tr {
            border-bottom: 1px solid rgb(165, 163, 163, 0.7);
            /* padding-right: 40px; */
            /* padding-bottom: 50px; */
            /* margin-bottom: 30px; */

        }

        .tooltip {
            position: relative;
            display: inline-block;
            /* border-bottom: 1px dotted black; */
        }

        .tooltip .tooltiptext {
            visibility: hidden;
            width: 150px;
            background-color: black;
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 1px 0;

            /* Position the tooltip */
            position: absolute;
            z-index: 1;
            font-size: 12px;
            margin-left: 7px;
            margin-top: -20px;
        }

        .tooltip .tooltiptext::after {
            content: " ";
            position: absolute;
            top: 50%;
            right: 100%;
            /* To the left of the tooltip */
            margin-top: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: transparent black transparent transparent;
        }

        .tooltip:hover .tooltiptext {
            visibility: visible;
        }

        .title {
            text-align: center;
        }

        .div1 {
            margin-left: 70px;
        }

        .info {
            font-size: 20px;
            opacity: 0.6;
        }

        /* thead {
            padding: 600px;
        } */

        th {
            font-size: 13px;
            color: rgb(51, 50, 50);
            padding-bottom: 10px;
            text-align: left;
            /* padding: 5px 40px 10px 0px; */

            /* padding: 10px; */

            /* padding-right:    -300px !important; */
            padding-left: 100px;
        }

        th.height {
            width: 5%;
            /* padding-left: 700px; */
            left: 0;
            padding-left: 2px;
            /* padding-right: 10px; */
        }

        th.nonce {
            width: 5%;
            /* padding-left: 700px; */
            left: 0;
            padding-left: 2px;
            /* padding-right: 10px; */
        }

        .date {
            width: 20%;
            /* padding-left: 700px; */
            left: 0;
            padding-left: 40px;
            /* padding-right: 10px; */
        }

        th.hash {
            width: 38%;
            padding-left: 2px;
        }

        td {
            /* padding-bottom: 50px; */
            /* margin-right: 40px; */

            /* padding: 10px; */
            text-align: left;
            /* padding-right: 140px; */
            padding: 10px 0px;
        }

        a {
            text-decoration: none;
        }

        a:hover {
            text-decoration: underline;
            color: black;
        }

        .pagination {
            /* display: inline-block; */
            /* text-align: center; */
            display: none;
            /* margin-left: 800px; */
            float: right;
            margin-top: -30px;
            margin-right: 50px;
        }

        .pagination button {
            color: black;
            float: left;
            padding: 8px 16px;
            text-decoration: none;
            transition: background-color .3s;
            /* border: 1px solid #ddd; */
            border: 1px solid rgb(165, 163, 163, 0.7);
        }

        .pagination button.active {
            background-color: rgb(68, 67, 67, 0.6);
            color: white;
            border: 1px solid rgb(68, 67, 67, 0.6);
        }

        .pagination button:hover:not(.active, .prev) {
            background-color: rgb(68, 67, 67, 0.3);
        }

        .count {
            margin-left: 60px;
            margin-top: -10px;
        }

        .noHover {
            pointer-events: none;
        }

        #msg {
            text-align: center;
            opacity: 0.8;
            display: none;
            opacity: 0;
        }

        .c1 {
            position: absolute;
            font-size: 15px;
            padding: 5px;
            border-radius: 3px;
            right: 194px;
            width: 82px;
        }
    </style>
    <script>

        // window.history.forward();
        // function noBack() {
        //     window.history.forward();
        // }
        $(document).ready(function () {

            // Get login user public key...
            var loginUserId = Number(JSON.parse(localStorage.getItem("login_user")).userDetails.user_id);
            console.log('loginUserId-----------------', loginUserId);

            let options = {
                method: 'GET',
                headers: {
                    'Content-Type':
                        'application/json;charset=utf-8'
                },
            }
            let fetchRes = fetch(`http://192.168.0.120:3000/api/user/${loginUserId}`, options);
            fetchRes.then(res =>
                res.json()).then(d => {
                    console.log('d-----------------', d);
                    let loginUserPublicKey = d.data.userDetails.wallet.public_key
                    console.log('login user data-----------------------', loginUserPublicKey);
                    // return loginUserPublicKey;
                    localStorage.setItem('loginUserPublicKey', loginUserPublicKey)
                    getData(1);
                    pagination("btn1")
                })
        });
        console.log('=============================', localStorage.getItem('loginUserPublicKey'));
        let data = {
            public_key: localStorage.getItem('loginUserPublicKey')
        }
        console.log('daat===================', data);
        // localStorage.removeItem('loginUserPublicKey');
        function getData(currentPage) {
            // pagination("#btn1")
            let queryParams = { page: Number(currentPage), limit: 15 };
            data = { ...data, ...queryParams }
            $.ajax({
                url: 'http://192.168.0.120:3000/api/user/transaction-history', // + $.param(queryParams),
                type: 'GET',
                dataType: 'json',
                data: data,
                success: function (response) {
                    // pagination("btn1")
                    console.log('response-------getData ---history---', response);
                    console.log('aaaaaaaaaaaaaa', response.data.chainInstance);
                    // response.data = []
                    let history = response.data.chainInstance;
                    if (history.length == 0) {
                        $("#msg").css("display", "block")
                        $("#msg").css("opacity", "1.0")
                        $("#msg").html(`No Record found of user transaction.`)

                    } else {
                        let total = response.data.count;
                        console.log('total----------------', total);
                        let totalPages = Math.ceil(total / data.limit);
                        console.log('totalPages--------------', totalPages);

                        localStorage.setItem('totalPages', totalPages)
                        let skip = skipData(currentPage, data.limit)
                        console.log('currentPage------------', currentPage, totalPages, skip);
                        $("#p1").html(`Showing ${skip + 1} to ${total} of ${total} entries`)
                        var trHTML = '';
                        console.log('r---------test-----------', response, history.length);
                        if (total > data.limit) {
                            // pagination("btn1")
                            $("#pagination").attr("style", "opacity:1")
                            $("#pagination").attr("style", "display:inline-block");
                            let tPage = skip + data.limit > total ? total : skip + data.limit;
                            $("#p1").html(`Showing ${skip + 1} to ${tPage} of ${total} entries`)

                            // pagination("btn1")
                        }
                        $.each(history, function (i, value) {
                            // trHTML += '<tr>' +
                            //     '<td>' + value.height + '</td>' +
                            //     '<td>' + value.prevHash + '</td>' +
                            //     '<td>' + value.transaction + '</td>' +
                            //     '<td>' + value.nonce + '</td>' +
                            //     '<td>' + value.ts + '</td>' +
                            //     // '<td><a id="a" href="http://localhost:8888/product-details">view</a></td>'
                            //     `<td><a id="a" href="http://localhost:8888/product/${value.id}">view</a></td>`

                            // '</tr>';


                            var timestamp = value.ts;
                            var date = new Date(timestamp);
                            value.ts = date.getDate() +
                                "/" + (date.getMonth() + 1) +
                                "/" + date.getFullYear() +
                                " " + date.getHours() +
                                ":" + date.getMinutes() +
                                ":" + date.getSeconds()

                            trHTML += '<tr>' +
                                `<td><a id="" href=""> ${value.height}</a></td>` +
                                `<td><a id="" href="">${value.prevHash}</a></td>` +
                                `<td><a id="" href="">${value.transaction}</a></td>` +
                                '<td>' + value.nonce + '</td>' +
                                '<td class = "date">' + value.ts + '</td>'
                            '</tr>';
                        });
                        // $('#tnxHistory').append(trHTML);
                        $('#tableBody').html(trHTML);
                    }
                },
                error: function (xhr, textStatus, errorThrown) {
                    console.log('Error in Operation');
                }
            });
        }
        // })
    </script>
</head>

<body>

    <!-- <body onLoad="noBack();" onpageshow="if (event.persisted) noBack();" onUnload=""> -->
    <div class="container">
        <div class="div1">
            <h1 class="title"><i> Transactions History </i></h1>
            <button class="c1" onclick="window.location='http://192.168.0.120:3000/api/wallet'">Cancel</button>
            <h2>Blocks
                <div class="tooltip"><i class="fa fa-info-circle info"></i>
                    <span class="tooltiptext">
                        <p> Blocks contain validated Bitcoin network transactions.</p>
                    </span>
                </div>
                <!-- <div class="tooltip">&#x1F6C8;
                    <span class="tooltiptext">Tooltip text</span>
                </div> -->
            </h2>
        </div>

        <table id="tnxHistory">
            <thead>
                <tr>
                    <th class="height">Height</th>
                    <th class="hash">Previous Hash</th>
                    <th class="hash">Transaction</th>
                    <th class="nonce">Nonce</th>
                    <th class="date">Mined</th>
                </tr>
            </thead>
            <tbody id="tableBody">
                <!-- <tr class="border-bottom"> -->
                <!-- <td>Text 1 000000000 0000000 0000000</td>
                    <td>Text 3000/api00 000000000000000</td> -->
                <!-- </tr> -->
            </tbody>
        </table>
        <p id="msg"></p>
        <div>
            <div class="count">
                <!-- <p id="p1">Showing 1 to 15 of 20 entries</p> -->
                <p id="p1"></p>
            </div>
            <div id="pagination" class="pagination">
                <button id="prev" class="prev" disabled>&laquo;</button>
                <button id="btn1" class="active" onclick="pagination(this.id)">1</button>
                <button id="btn2" onclick="pagination(this.id)">2</button>
                <button id="btn3" onclick="pagination(this.id)">3</button>
                <button id="next" class="next">&raquo;</button>
            </div>
        </div>
    </div>
</body>

<script>
    // pagination("btn1")
    // $("#pagination").attr("style", "opacity:1")
    // $("#pagination").attr("style", "display:inline-block")
    totalPages = Number(localStorage.getItem('totalPages'));
    function pagination(pageId) {
        if (Number($("#btn2").text()) > totalPages) {
            $("#btn2").attr("disabled", true)
            $("#btn2").addClass('noHover')
            $("#btn3").attr("disabled", true)
            $("#btn3").addClass('noHover')
            $("#next").attr("disabled", true)
            $("#next").addClass('noHover')
        } else {
            if (Number($("#btn3").text()) > totalPages) {
                $("#btn3").attr("disabled", true)
                $("#btn3").addClass('noHover')
                $("#next").attr("disabled", true)
                $("#next").addClass('noHover')
            }

            else if (Number($("#btn3").text()) == totalPages) {
                $("#next").attr("disabled", true)
                $("#next").addClass('noHover')
            } else {
                $("#next").attr("disabled", false)
                $("#next").removeClass('noHover')
            }

        }

        let getBtn = document.getElementById(pageId);
        page = Number($(`#${pageId}`).text());
        console.log('page-------------------', page);
        let activeElementId = document.getElementsByClassName('active')[0].id;
        console.log('activeElementId============', activeElementId);
        $(`#${activeElementId}`).removeClass('active');
        $(`#${pageId}`).addClass('active');
        if (page == 1) {
            $("#prev").attr("disabled", true)
            $("#prev").addClass('noHover')
            // return getData(page);
        } else {
            if (page > 1 && page < totalPages) {
                $("#prev").attr("disabled", false)
                $("#prev").removeClass('noHover')

                $("#next").attr("disabled", false)
                $("#next").removeClass('noHover')
                return getData(page);
            }
            if (page >= totalPages) {
                $("#next").attr("disabled", true)
                $("#next").addClass('noHover')

                $("#prev").attr("disabled", false)
                $("#prev").removeClass('noHover')
                return getData(page);
            }
            if (page > totalPages) {
                $(`#${pageId}`).attr("disabled", true)
                $(`#${pageId}`).addClass('noHover')
                return getData(page);
            }

        }
        // return getData(page);
        // getData(pageId)
    }

    $("#next").click(function () {
        activeBtnId = document.getElementsByClassName('active')[0].id
        if (activeBtnId == 'btn1') {
            $(`#btn1`).removeClass('active');
            $(`#btn2`).addClass('active');
            return getData($(`#btn2`).text());
        }
        else if (activeBtnId == 'btn2') {
            $(`#btn2`).removeClass('active');
            $(`#btn3`).addClass('active');
            return getData($(`#btn3`).text());
        } else {
            btns = document.getElementsByTagName("button");
            lastbtnVal = Number($("#btn3").text());
            $("#btn1").html(Number($("#btn1").text()) + 3);
            $("#btn2").html(Number($("#btn2").text()) + 3);
            $("#btn3").html(Number($("#btn3").text()) + 3);

            ["btn1", "btn2", "btn3"].forEach(b => pagination(b))
            $(`#btn1`).addClass('active');
            $(`#btn3`).removeClass('active');
            return getData($(`#btn1`).text());
        }
    })

    $("#prev").click(function () {
        activeBtnId = document.getElementsByClassName('active')[0].id
        if (activeBtnId == 'btn3') {
            $(`#btn3`).removeClass('active');
            $(`#btn2`).addClass('active');
            return getData($(`#btn2`).text());
        }
        if (activeBtnId == 'btn2') {
            $(`#btn2`).removeClass('active');
            $(`#btn1`).addClass('active');
            if ($(`#${activeBtnId}`).text() == 2) {
                $("#prev").attr("disabled", true)
                $("#prev").addClass('noHover')
            }
            return getData($(`#btn1`).text());
        }
        if (activeBtnId == 'btn1') {
            $(`#btn1`).removeClass('active');
            $(`#btn3`).addClass('active');


            if ($(`#${activeBtnId}`).text() == 1) {
                $("#prev").attr("disabled", true)
                $("#prev").addClass('noHover')
            }
            btns = document.getElementsByTagName("button");
            lastbtnVal = Number($("#btn3").text());
            $("#btn1").html(Number($("#btn1").text()) - 3);
            $("#btn2").html(Number($("#btn2").text()) - 3);
            $("#btn3").html(Number($("#btn3").text()) - 3);

            ["btn1", "btn2", "btn3"].forEach(b => pagination(b))
            $("#btn2").attr("disabled", false)
            $("#btn2").removeClass('noHover')
            $("#btn3").attr("disabled", false)
            $("#btn3").removeClass('noHover')
            return getData($(`#btn3`).text());
        }
    })

    function skipData(page, limit = 15) {
        skip = (page - 1) * limit;
        return skip;
    }

    let page = document.getElementById("pagination");
    var prev = $(".pagination 1");
    var active = $(".pagination a.active");

</script>

</html>